---
title: "Getting Demographic Data"
author: "Martin Summer"
format: html
editor: source
---

## Reading the IDB data

We would like to get a global demographic dataset using the data from the idbr 
database in the US. We try to work with the idbr package provided by walker, which
reads the IDB census data, a data collection from the US census bureau: https://github.com/walkerke/idbr
The API key is 8b046bdcea1cc2ba58889846bf066ffc73c70ebe

This package does not seem to work or the communication with the API is difficult.
So we will not execute the following code.

```{r}
# library(devtools)
# install_github('walkerke/idbr')
# 
# library(idbr)
# idb_api_key('8b046bdcea1cc2ba58889846bf066ffc73c70ebe')
```

We could instead of using the API download the dataset and read it with readr

```{r}
library(readr)
```

This reads the 5 years datafile from the IDB

```{r}
dat <- read_delim("~/R/Statistics_JWL/data/people_count/idb5yr.txt", delim = "|")
```

```{r}
# It looks like the last two characters in GEO_ID are country codes. Let's try this and see where we
# get

# write function to extract the last two characters from a string

substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}

# extract the last two characters from GEO_ID

dat$GEO_ID <- substrRight(dat$GEO_ID,2)
```


```{r}
# read ISO codes

iso <- read_csv("~/R/Statistics_JWL/data/people_count/ISO-alpha2.csv", show_col_types = F)
names(iso) <- c("GEO_ID", "Name")
```

```{r}
# read variable labels

my_labels <- read_csv("~/R/Statistics_JWL/data/people_count/labels.csv", show_col_types = FALSE)

```

```{r}
# See what is in dat$GEO_ID

iso_dat <- as.data.frame(unique(dat$GEO_ID))
names(iso_dat) <- c("GEO_ID")
```

Compare the codes and countries:

```{r}
test <- merge(iso_dat, iso, by = "GEO_ID", all = TRUE)
missing <- test[is.na(test$Name), ]
```

```{r}
test[160, 2] <- "Namibia"
test[245, 2] <- "Gazastrip"
test[246, 2] <- "Kosovo"
test[247, 2] <- "Westbank"
```

```{r}
all_countries <- test[1:(nrow(test)-1), ]
```

```{r}
# match iso and countries and then bring name column to the front as the first
# column

data <- merge(dat, all_countries, by = "GEO_ID", all.x = T)
data_final <- data[,c(ncol(data),1:(ncol(data)-1))]
```


```{r}
names(data_final) <- c("Country", "ISO2", "Year", "Area_km2", names(data_final)[5:length(data_final)])
```

## Tidying

The data have no tidy format which makes it awkward to work with them on the 
computer. We split up the data set into non stratified data, data stratified by sex, data 
stratified by age, data stratified by sex and age

```{r}
library(tidyverse)
```

```{r}
names(data_final)
```
### Split up into blocks

```{r}
# Split up data:

# population numbers:

population_numbers <- bind_cols(data_final[,1:3], data_final[ , str_detect(names(data_final),"^[MF].*(_[0-9]+|_[0-9]+_)$") & !(names(data_final) %in% c("FMR0_4", "FMR1_4", "MMR0_4", "MMR1_4", "MR1_4", "MR0_4"))])

# infant and children mortality data

child_mortality <- bind_cols(data_final[,1:3], data_final[ , names(data_final) %in% c("FMR0_4", "FMR1_4", "MMR0_4", "MMR1_4")])

infant_mortality <- bind_cols(data_final[,1:3], data_final[ , names(data_final) %in% c("IMR_F", "IMR_M")])

# Birth and Death

birth_and_death <- bind_cols(data_final[,1:3], data_final[ , 
                    str_detect(names(data_final),"\\b(?:E0_F|E0_M|MEDAGE_M|MEDAGE_F)\\b")])

# Birth to mothers of age

birth_to_mothers_of_age <- bind_cols(data_final[,1:3], data_final[ , str_detect(names(data_final),"BIRTHS\\d{1,2}_\\d{1,2}")])

# Age specific fertility rate

age_specific_fertility <- bind_cols(data_final[,1:3], data_final[ , str_detect(names(data_final),".*ASFR.*")])

# general demographic variables

dem_names <- data_final[ , str_detect(names(data_final),"^[^0-9]*([0-9])?[^0-9]*$")]
dem_names <- dem_names[, str_detect(names(dem_names), "^(?!.*(_M|_F)).*$")]                    
dem_names <- dem_names[, str_detect(names(dem_names), "^(?!FPOP|MPOP|POP_DENS).*$")]

```



#### Population data

```{r}
population_statistics <- population_numbers %>% 
  pivot_longer(
    cols = !c("Country", "ISO2", "Year"),
    names_to = c("Sex", "Variable", "Age"),
    names_pattern = "([MF])([^MF\\d_]+)(\\d{1,2}_\\d{1,2})",
    values_to = "Value"
  ) %>% 
pivot_wider(
  names_from = Variable,
  values_from = Value
)
```

#### Child and infant mortality data

```{r}

child_mortality_statistics <- child_mortality %>% 
  pivot_longer(
   cols = !c("Country", "ISO2", "Year"),
   names_to = c("Sex", "Variable", "Age"),
   names_pattern = "^([FM])(MR)([01]_4)$",
   values_to = "Value"
  ) %>% 
pivot_wider(
  names_from = Variable,
  values_from = Value
)
```

```{r}
infant_mortality_statistics <- infant_mortality %>% 
  pivot_longer(
   cols = !c("Country", "ISO2", "Year"),
   names_to = c("Variable", "Sex"),
   names_pattern = "^(IMR)_(F|M)$",
   values_to = "Value"
  )%>% 
pivot_wider(
  names_from = Variable,
  values_from = Value
)
```

#### Birth and Death

```{r}
life_expectancy_by_sex <-birth_and_death %>% 
  pivot_longer(
    cols = !c("Country", "ISO2", "Year"),
   names_to = c("Variable", "Sex"),
   names_pattern = "^([A-Z0-9]+)_(M|F)$",
   values_to = "Value"
  )%>% 
pivot_wider(
  names_from = Variable,
  values_from = Value
)
  
```

#### Birth to mothers of age

```{r}
age_specific_birth_statistics <- birth_to_mothers_of_age %>% 
   pivot_longer(
    cols = !c("Country", "ISO2", "Year"),
   names_to = c("Variable", "Age"),
   names_pattern = "^(BIRTHS)(\\d{2}_\\d{2})$",
   values_to = "Value"
  )%>% 
pivot_wider(
  names_from = Variable,
  values_from = Value
)
```


#### Age specific fertility

```{r}
age_specific_fertility_statistics <- age_specific_fertility %>% 
  pivot_longer(
    cols = !c("Country", "ISO2", "Year"),
   names_to = c("Variable", "Age"),
   names_pattern = "^(ASFR)(\\d{2}_\\d{2})$",
   values_to = "Value"
  )%>% 
pivot_wider(
  names_from = Variable,
  values_from = Value
)
    
  
```

#### General demographics

```{r}
general_demographics <- dem_names
```
### Clean up strings

```{r}

age_specific_birth_statistics$Age <- gsub("_", "-", age_specific_birth_statistics$Age)

age_specific_fertility_statistics$Age <- gsub("_", "-", age_specific_fertility_statistics$Age)

child_mortality_statistics$Age <- gsub("_", "-", child_mortality_statistics$Age)

population_statistics$Age <- gsub("_", "-", population_statistics$Age)

```

### Define correct types or classes for variables

 

```{r}

my_countries <- unique(population_statistics$Country)
population_statistics$Country <-  factor(population_statistics$Country, levels = my_countries)

my_iso <- unique(population_statistics$ISO2)
population_statistics$ISO2 <- factor(population_statistics$ISO2, levels = my_iso)

my_sex <- unique(population_statistics$Sex)
population_statistics$Sex <- factor(population_statistics$Sex, levels = my_sex)

my_age <- c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", 
            "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", 
            "80-84", "85-89", "90-94", "95-99")

population_statistics$Age <- factor(population_statistics$Age, levels = my_age)
```

The problem is that the age column is not correctly ordered by the age factor. We correct
this, so we have correctly ordered age classes throughout the frame

```{r}

# population

#define number of data frames to split into
n <- dim(population_statistics)[1]/20

#split data frame into n equal-sized data frames
aux <- split(population_statistics, factor(sort(rank(row.names(population_statistics))%%n)))

corr <- function(x){ with(x, x[order(Age, ISO2), ])}

res <- lapply(aux, corr)

population_statistics_ordered <- do.call(bind_rows, res)

population_statistics_by_age_and_sex <- population_statistics_ordered
```

### Label variables

```{r}
library(Hmisc)

var_labels_1 <- c(Country = "Country", ISO2="alpha2 country code", Year = "Year", Sex = "Sex", Age = "Age in 5 year intervals", POP = "Total midyear population")

label(population_statistics_by_age_and_sex) = as.list(var_labels_1[match(names(population_statistics_by_age_and_sex), names(var_labels_1))])
```

```{r}
var_labels_2 <- c(Country = "Country", ISO2="alpha2 country code", Year = "Year", Sex = "Sex", Age = "Age in 5 year intervals", MR = "Mortality Rate, deaths per 1000")
label(child_mortality_statistics) = as.list(var_labels_2[match(names(child_mortality_statistics), names(var_labels_2))])
```
 
```{r}
var_labels_3 <- c(Country = "Country", ISO2="alpha2 country code", Year = "Year", Sex = "Sex", 
                  IMR = "Infant Mortality Rate, deaths per 1000")
label(infant_mortality_statistics) = as.list(var_labels_3[match(names(infant_mortality_statistics), names(var_labels_3))])
```

```{r}
var_labels_4 <- c(Country = "Country", ISO2="alpha2 country code", Year = "Year", E0 = "Life Expectancy", MEDAGE = "Median age")
label(life_expectancy_by_sex) = as.list(var_labels_4[match(names(life_expectancy_by_sex), names(var_labels_4))])
```

```{r}
var_labels_5 <- c(Country = "Country", ISO2="alpha2 country code", Year = "Year", Age = "Age in 5 years interv", BIRTHS = "Number of births")
label(age_specific_birth_statistics) = as.list(var_labels_5[match(names(age_specific_birth_statistics), names(var_labels_5))])
```

```{r}
var_labels_6 <- c(Country = "Country", ISO2="alpha2 country code", Year = "Year", Age = "Age in 5 year intervals", ASFR="Age specific fertility rate")
label(age_specific_fertility_statistics) = as.list(var_labels_5[match(names(age_specific_fertility_statistics), names(var_labels_5))])
```

```{r}
var_labels_7 <- c(Country = "Country", 
                  ISO2="alpha2 country code", 
                  Year = "Year", 
                  Area_km2 = "Area in square km", 
                  CBR = "Crude birth rate (births per 1,000 population)",
                  CDR = "Crude death rate (deaths per 1,000 population)",
                  E0 = "Both sexes life expectancy at birth",
                  GR = "Growth rate (percent)",
                  GRR = "Gross reproduction rate (lifetime births per woman)",
                  IMR = "Infant mortality rate",
                  NMR = "Net migration rate",
                  POP = "Population",
                  RNI = "Rate of natural increase (percent)",
                  SRB = "Sex ratio at birth (males per female)",
                  TFR = "Total fertility rate",
                  BIRTHS = "Number of births",
                  DEATHS = "Number of deaths",
                  NIM = "Net international migrants, both sexes",
                  NATINCR = "Natural increase",
                  MEDAGE = "Median age",
                  SEXRATIO = "Sex ration (males to females",
                  DEPND = "Dependency ration, both sexes"
                  )
label(general_demographics) = as.list(var_labels_6[match(names(general_demographics), names(var_labels_6))])
```


### Package data

```{r}
usethis::use_data(general_demographics)
usethis::use_data(age_specific_fertility_statistics)
usethis::use_data(age_specific_birth_statistics)
usethis::use_data(population_statistics_by_age_and_sex)
usethis::use_data(child_mortality_statistics)
usethis::use_data(life_expectancy_by_sex)
usethis::use_data(infant_mortality_statistics)
```

